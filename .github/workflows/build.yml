name: Build

on: push

jobs:
  build:
    strategy:
      matrix:
        os: [[self-hosted, nix, macOS], [self-hosted, nix, Linux]]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: om ci
      - name: Upload to cache
        run: nunu-upload-to-cache

  release:
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: "write"
    runs-on: [self-hosted, nix, Linux]
    needs: [build]
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      released: ${{ steps.get-version.outputs.released }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Release
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          nix run .#bump-version

      - name: Pull new tag
        run: |
          echo "Fetching new tags and commits..."
          git fetch --tags origin
          BRANCH=${GITHUB_REF#refs/heads/}
          git pull origin $BRANCH
          echo "Current HEAD:"
          git log -1 --oneline --decorate

      - name: Get version
        id: get-version
        run: |
          TAG=$(git describe --exact-match --tags HEAD 2>/dev/null || echo "")
          echo "Tag on HEAD: '$TAG'"

          if [ -n "$TAG" ] && [[ "$TAG" == v* ]]; then
            VERSION=$(echo "$TAG" | sed 's/^v//')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "released=true" >> $GITHUB_OUTPUT
            echo "✓ Released version $VERSION"
          else
            echo "released=false" >> $GITHUB_OUTPUT
            echo "ℹ No release tag created (no version bump needed)"
          fi

  post-release-build-linux:
    if: github.ref == 'refs/heads/feat/intel_macos'
    runs-on: [self-hosted, nix, Linux]
    needs: [build]
    outputs:
      arch: ${{ steps.detect-arch.outputs.arch }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect architecture
        id: detect-arch
        run: |
          ARCH=$(uname -m)
          echo "arch=$ARCH" >> $GITHUB_OUTPUT
          echo "Detected architecture: $ARCH"

      - name: Build release artifacts
        run: nix build .#release-artifacts --refresh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries-linux
          path: |
            result/bin/nunu-cli
            result/bin/nunu-cli.exe

  post-release-build-macos:
    if: github.ref == 'refs/heads/feat/intel_macos'
    runs-on: [self-hosted, nix, macOS]
    needs: [build]
    outputs:
      arch: ${{ steps.detect-arch.outputs.arch }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect architecture
        id: detect-arch
        run: |
          ARCH=$(uname -m)
          echo "arch=$ARCH" >> $GITHUB_OUTPUT
          echo "Detected architecture: $ARCH"
          echo "Nix system: $(nix eval --impure --raw --expr 'builtins.currentSystem')"
          echo "Checking if macos-x86_64 package exists..."
          nix flake show --json 2>/dev/null | jq -r ".packages.\"$(nix eval --impure --raw --expr 'builtins.currentSystem')\" | keys[]" || echo "Unable to list packages"

      - name: Build release artifacts
        run: nix build .#release-artifacts --refresh

      - name: List built artifacts
        run: |
          echo "Built artifacts:"
          ls -lh result/bin/
          echo "---"
          echo "Files to upload:"
          ls -1 result/bin/nunu-cli-*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries-macos
          path: |
            result/bin/nunu-cli-*

  create-github-release:
    if: github.ref == 'refs/heads/main' && needs.release.outputs.released == 'true'
    permissions:
      contents: "write"
    runs-on: [self-hosted, nix, Linux]
    needs: [release, post-release-build-linux, post-release-build-macos]
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-binaries-linux
          path: artifacts

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-binaries-macos
          path: artifacts-macos

      - name: Rename artifacts with version
        run: |
          VERSION=${{ needs.release.outputs.version }}
          LINUX_ARCH=${{ needs.post-release-build-linux.outputs.arch }}
          mv artifacts/nunu-cli artifacts/nunu-cli-linux-${LINUX_ARCH}
          mv artifacts/nunu-cli.exe artifacts/nunu-cli-windows-${LINUX_ARCH}.exe

          # Copy macOS binaries (already have architecture in filename from flake)
          cp artifacts-macos/nunu-cli-* artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.release.outputs.version }}
          name: Release v${{ needs.release.outputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/nunu-cli-linux-*
            artifacts/nunu-cli-windows-*.exe
            artifacts/nunu-cli-macos-*
          generate_release_notes: true
