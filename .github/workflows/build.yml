name: Build

on: push

jobs:
  build:
    strategy:
      matrix:
        os: [[self-hosted, nix, macOS], [self-hosted, nix, Linux]]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: om ci
      - name: Upload to cache
        run: nunu-upload-to-cache

  release:
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: "write"
    runs-on: [self-hosted, nix, Linux]
    needs: [build]
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      released: ${{ steps.get-version.outputs.released }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Release
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          nix run .#bump-version
      - name: Get version
        id: get-version
        run: |
          # Check if HEAD has a tag matching v* pattern (CHANGED)
          TAG=$(git describe --exact-match --tags HEAD 2>/dev/null || echo "")
          if [ -n "$TAG" ] && [[ "$TAG" == v* ]]; then
            VERSION=$(echo "$TAG" | sed 's/^v//')  # Remove v prefix
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "released=true" >> $GITHUB_OUTPUT
          else
            echo "released=false" >> $GITHUB_OUTPUT
          fi

  post-release-build:
    if: github.ref == 'refs/heads/main' && needs.release.outputs.released == 'true'
    runs-on: [self-hosted, nix, Linux]
    needs: [release]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      - name: Build release artifacts
        run: nix build .#release-artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries
          path: |
            result/bin/nunu-cli
            result/bin/nunu-cli.exe

  create-github-release:
    if: github.ref == 'refs/heads/main' && needs.release.outputs.released == 'true'
    permissions:
      contents: "write"
    runs-on: [self-hosted, nix, Linux]
    needs: [release, post-release-build]
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-binaries
          path: artifacts
      - name: Rename artifacts with version
        run: |
          VERSION=${{ needs.release.outputs.version }}
          mv artifacts/nunu-cli artifacts/nunu-cli-v${VERSION}-linux-x86_64
          mv artifacts/nunu-cli.exe artifacts/nunu-cli-v${VERSION}-windows-x86_64.exe
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.release.outputs.version }}  # CHANGED: v0.1.6 instead of nunu-cli-v0.1.6
          name: Release v${{ needs.release.outputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/nunu-cli-v${{ needs.release.outputs.version }}-linux-x86_64
            artifacts/nunu-cli-v${{ needs.release.outputs.version }}-windows-x86_64.exe
          generate_release_notes: true
